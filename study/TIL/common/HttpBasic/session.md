## 세션

> 서버 세션을 이용하면 클라이언트의 상태를 저장할 수 있다. 쿠키와의 차이점은 쿠키는 클라이언트에 상태를
> 저장하지만 세션은 서버에 저장한다는 점이다.

### 1. 세션 기본 객체

세션을 사용한다는 것은 세션 기본 객체를 사용한다는 것을 말한다. request 객체와 마찬가지로 속성을
제공하므로 getAttribute(), setAttribute() 등의 메서드를 이용해서 속성값을 저장하거나 읽어올 수 있다.

#### 1.1세션 ID

웹 브라우저는 각각 별도의 세션을 갖는다. 이때 각 세션을 구분하기 위해 세션마다 고유 ID를 할당하는 데,
이것이 세션 ID이다. 웹 서버는 웹 브라우저에 세션 ID를 전송하고, 웹 브라우저는 웹 서버에 연결할 때마다
세션 ID를 보내서 웹 서버가 어떤 세션을 사용할 지 판단할 수 있게 한다.

웹 서버는 세션 ID를 통해 웹 브라우저를 위한 세션을 찾기 때문에, 웹 서버와 웹 브라우저는 세션 ID를 공유할
방법이 필요하다. 세션 ID를 공유하기 위해 사용되는 것은 쿠키이다.

### 2. 세션 유지 시간

한 번 생성된 세션은 지정한 유효 시간 동안 계속 유지된다. request 객체의 경우 하나의 요청을 처리하는
데 사용되는 웹 페이지 내에서 사용된다면, 세션은 여러 요청을 처리하는 웹 페이지 사이에서 공유된다. 따라서
로그인한 회원 정보 등 웹 브라우저와 일대일로 관련된 값을 저장할 때 쿠키 대신 세션을 이용할 수 있다.

#### 2.1 쿠키 vs 세션

쿠키 대신 세션을 이용하는 이유는 쿠키보다 세션이 보안에서 더 앞선다는 점 때문이다. 쿠키의 경우 HTTP 프로토콜을 이용해서
전송하기 때문에 중간에 누군가가 가로챌 위험이 있다. 하지만 세션의 경우 오로지 서버에만 저장되기 때문에
중요한 데이터를 보관하기에는 알맞은 장소이다.

하지만 세션은 여러 서버에서 공유할 수 없다. 예를 들어 www.daum.net 과 mail.daum.net 의 세션은 서버가 다르기 때문에
공유할 수 없다. 하지만 쿠키는 도메인을 이용해서 쿠키를 여러 도메인에 공유할 수 있다는 장점이 있다. 이런 이유로
포털 사이트마다 로그인 정보를 저장하는 방식은 각각 다르다.

#### 2.2 세션 유효 시간

세션은 유효 시간을 갖는다. 이 유효 시간은 WEB-INF\web.xml 파일에 <session-config> 태그를 이용해서
세션 유효 시간을 설정할 수 있다. 예를 들어, 세션 유효 시간을 50분으로 설정하고 싶다면 다음과 같이 작성할
수 있다.

```xml
<session-config>
    <session-timeout>50</session-timeout>
</session-config>
```

세션 유효 시간을 0이나 음수로 설정하면 세션은 유효 시간을 갖지 않는다. 이 경우 명시적으로 사용자가 session.invalidate() 메서드를 호출하기
전까지 세션 객체가 서버에 유지된다. 세션 객체가 제거되지 않으면 시간이 흐를수록 세션 객체가 메모리에 누적되기
때문에 메모리 부족 현상이 발생할 수 있다. 따라서 이러한 현상을 막기 위해 세션의 timeout 시간은 반드시 지정해주어야 한다.


### 3. 세션을 사용한 로그인 상태 유지

세션을 사용해서 로그인을 처리하는 방식은 다음 순서를 따른다.

1. 로그인 성공 시, **세션 기본 객체의 특정 속성**에 데이터를 기록한다.
2. 이후로 **세션 기본 객체의 특정 속성**이 존재하면 로그인 한 것으로 간주한다.
3. 로그아웃 시 session.invalidate() 메서드를 호출하여 세션을 종료한다.

#### 3.1 연관된 정보 저장을 위한 클래스 작성

세션 객체를 저장할 때 다음과 같이 작성하면 유지 보수에 큰 어려움을 겪는다.

```java
String memberId = (String)session.setAttribute("memberId");
String name = (String)session.setAttribute("name");
String email = (String)session.setAttribute("email");
boolean male = (Boolean)session.setAttribute("mail");
```

코드를 이렇게 작성하면 Member 클래스 내부의 필드가 증가할수록 코드를 분석하는 시간도 길어지고, 연관된
속성 중 일부를 실수로 잘못 처리할 수도 있다. 따라서 연관된 정보는 하나의 클래스로 묶어서 저장하도록 한다.

```java
MemberInfo memberInfo = new MemberInfo(id, name);
session.setAttribute("memberInfo", memberInfo);
```

연관된 정보를 한 객체에 담아 저장하기 때문에, 세션에 저장한 객체를 사용할 때에도 다음과 같이 객체를
가져온 뒤 객체로부터 필요한 값을 읽어올 수 있다. 이렇게 하면 코드 가독성도 좋아지고 만약 MemberInfo 클래스에서
email 필드가 사라졌을 때, getEmail() 메서드가 존재하지 않는다는 컴파일 에러가 발생하기 때문에 오류를 추적하기도
더 쉬워진다.

```java
MemberInfo member = (MemberInfo)session.getAttribute("memberInfo");
...
...
member.getEmail().toLowerCase()
```







